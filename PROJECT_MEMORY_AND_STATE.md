# Project Memory & State — RIQ LabMatch / Faculty Pipeline

**Purpose:** This document preserves what was done in recent work and how the system works, so you (or a new Cursor session) don’t lose track after updating Cursor or switching machines.

**Last updated:** February 2026 (align with your actual date if you edit this file.)

---

## 1. What Was Fixed and Implemented (Recent Work)

### Crashes and bugs
- **KeyError: 'school'** — NSF data uses `institution`; the app now normalizes in `load_faculty()` and uses `.get("school")` / `.get("institution")` everywhere so missing keys don’t crash.
- **Jinja2 `min` undefined** — The “Showing X–Y of Z labs” line in `templates/general.html` no longer calls `min()` in the template. The view in `app.py` computes `show_start` and `show_end` and passes them to the template.

### Find Labs (general) page — performance and UX
- **Pagination:** 20 professors per page. Google-style pagination (Previous, page numbers, Next). Filter params (school, department, technique, location) are kept in pagination links.
- **Priority order:** PIs with email + website are shown first; NSF-only (minimal data) PIs later. Implemented via `_pi_display_priority()` in `app.py`.
- **Filter choices cached:** `get_filter_choices()` builds schools, departments, techniques, locations once per faculty load and caches them so we don’t rescan the full list on every request.

### Onboarding and profile
- **Research topics:** Multi-select dropdown of common topics (e.g. machine learning, cancer research) plus an “Other” free-text field. List is in `COMMON_RESEARCH_TOPICS` in `app.py`.
- **Institution (optional):** User’s institution is a dropdown filled from the same institution list as Find Labs; stored in `UserProfile.institution`. DB migration for `institution` is in `init_db()`.
- **Account page:** Shows the user’s institution when set.

### Security and config
- Password reset: 8-character minimum; `.env.example` has placeholders for DATABASE_URL, SMTP, etc.

### Pushes to GitHub
- Changes were committed and pushed (e.g. “Fix KeyError, pagination, priority sort, onboarding dropdowns” and “Fix Jinja2 min undefined; add CHANGES_AND_DATA_LOCATIONS.md”).
- If push failed from the environment (e.g. network), the commits are local; run `git push origin main` from `faculty_pipeline/` when you have network.

---

## 2. Critical: What the Website Shows (Data Source)

**The website does NOT read your raw NSF download folders directly.**

- The app uses **one** faculty source, chosen at startup in this order:
  1. **`faculty_pipeline/output/nsf_all_faculty.json`** (if it exists) ← NSF data
  2. Else **`faculty_pipeline/output/harvard_mvp_1500.json`** (if it exists)
  3. Else **`faculty_pipeline/data/faculty_working.json`** (bundled sample)

- Your “downloaded data in NSF form” (e.g. `nsf_data/` or `~/Documents/RIQ/2023, 2024, 2025`) is **only** used by the **loader script**, which **writes** `output/nsf_all_faculty.json`. The Flask app never reads those raw folders.

**To make the website show all your NSF data:**  
Run the loader so that `output/nsf_all_faculty.json` exists (and is up to date):

```bash
cd faculty_pipeline
python scripts/load_all_nsf_data.py
# If your NSF files are elsewhere, e.g.:
python scripts/load_all_nsf_data.py ~/Documents/RIQ
```

Then (re)start the app. The site will use `output/nsf_all_faculty.json` and show that NSF-derived list.

---

## 3. Where Things Live (Quick Reference)

| What | Where |
|------|--------|
| **NSF raw bulk download (your files)** | You put them in `nsf_data/2023`, `2024`, `2025` or e.g. `~/Documents/RIQ/2023`, `2024`, `2025`. Not in GitHub (large). |
| **Script that turns NSF → faculty list** | `faculty_pipeline/scripts/load_all_nsf_data.py` |
| **Processed NSF faculty list (what the app reads)** | `faculty_pipeline/output/nsf_all_faculty.json` — **gitignored**, not in GitHub. Generated by the script above. |
| **Harvard/MVP fallback** | `faculty_pipeline/output/harvard_mvp_1500.json` |
| **Bundled fallback** | `faculty_pipeline/data/faculty_working.json` |
| **Database** | SQLite (path from `DATABASE_URL` or Flask default). Holds **only** users, profiles, saved PIs, resumes, password-reset tokens. **Does not** store the list of institutions or NSF PIs. |
| **App entrypoint** | `faculty_pipeline/app.py`. Faculty loaded via `load_faculty()` which reads `FACULTY_PATH` (see `app.py` ~line 305). |

---

## 4. NSF vs Other Data (For Grant / Reporting)

- **NSF data** = from **NSF Award Search bulk download** (file export). We do **not** use the NSF AwardSearch API; no API key.
- **Harvard/MVP data** = from a separate, non-NSF pipeline. Used only as fallback when `nsf_all_faculty.json` is missing.
- **Document for NSF reviewers:** `faculty_pipeline/NSF_DATA_SOURCES_AND_WEBSITE_FEATURES.md` — describes API vs Download, what the website uses, and caveats.

---

## 5. Key Files Created or Heavily Edited (For Grep / Search)

- `app.py` — `load_faculty()`, `get_filter_choices()`, `_pi_display_priority()`, general() pagination and `show_start`/`show_end`, onboarding institution + research_topics.
- `templates/general.html` — Pagination UI, “Showing X–Y of Z” using `show_start`/`show_end`.
- `templates/onboarding.html` — Research topics multi-select, institution dropdown.
- `templates/account.html` — Display institution.
- `CHANGES_AND_DATA_LOCATIONS.md` — Changelog + where NSF/institution data lives (for GitHub).
- `NSF_DATA_SOURCES_AND_WEBSITE_FEATURES.md` — For NSF grant: data sources, features, caveats.
- `PROJECT_MEMORY_AND_STATE.md` — This file (conversation memory / project state).

---

## 6. How to Launch the Website Locally

From the project root (parent of `faculty_pipeline`), using the venv in the parent:

```bash
cd faculty_pipeline
../.venv/bin/python app.py
```

Default port: **5001** (or set `PORT` env var).  
URL: **http://localhost:5001**

---

## 7. If You Need to Re-Orient After Updating Cursor

1. Read this file (`PROJECT_MEMORY_AND_STATE.md`).
2. Check `CHANGES_AND_DATA_LOCATIONS.md` for recent changes and data paths.
3. Check `NSF_DATA_SOURCES_AND_WEBSITE_FEATURES.md` for grant-related wording and data-source clarity.
4. To have the site use your full NSF set: run `scripts/load_all_nsf_data.py` so `output/nsf_all_faculty.json` exists, then start the app.

You can add to this document whenever something important is decided or implemented so it stays a reliable “memory” for the project.
