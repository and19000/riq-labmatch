{% extends "base.html" %}

{% block content %}
  <h1>Your Lab Matches</h1>
  <p class="subtitle">AI-powered matches based on your resume</p>

  {% if matches %}
    <div class="matches-header">
      <div>
        <p>Found <strong>{{ matches|length }}</strong> compatible lab{{ 's' if matches|length != 1 else '' }} for you</p>
        <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 0.5rem;">
          Select labs to compare or generate emails for multiple labs at once.
        </p>
      </div>
      <div class="matches-header-actions">
        <a href="{{ url_for('saved_pis') }}?compare=true" class="btn-secondary">Compare Labs</a>
        <a href="{{ url_for('resume_upload') }}" class="btn-secondary">Update Resume</a>
      </div>
    </div>

    <div class="labs-table-container">
      <table class="labs-table">
        <thead>
          <tr>
            <th style="width: 60px;">Logo</th>
            <th>Professor</th>
            <th>Title / Website</th>
            <th>Email</th>
            <th style="width: 100px; text-align: center;">Fit</th>
            <th style="width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for pi in matches %}
            <tr class="pi-row match-row" data-name="{{ pi.name|lower }}" data-institution="{{ pi.school|lower }}">
              <td>
                <div class="pi-logo">
                  {% if pi.get('institution_logo_url') %}
                    <img src="{{ pi.institution_logo_url }}" alt="{{ pi.school }} logo">
                  {% elif 'Harvard' in (pi.school or '') or 'harvard' in (pi.school or '').lower() %}
                    <svg class="harvard-logo-small" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                      <text x="100" y="70" font-family="serif" font-size="60" font-weight="bold" fill="#A51C30" text-anchor="middle">H</text>
                    </svg>
                  {% elif 'MIT' in (pi.school or '') or pi.school == 'MIT' %}
                    <svg class="mit-logo-small" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                      <text x="100" y="80" font-family="Arial, sans-serif" font-size="45" font-weight="bold" fill="#A31F34" text-anchor="middle">MIT</text>
                    </svg>
                  {% else %}
                    <div class="pi-logo-placeholder">{{ pi.school[0] if pi.school else pi.name[0] if pi.name else 'L' }}</div>
                  {% endif %}
                </div>
              </td>
              <td>
                <div class="table-lab-name">{{ pi.name }}</div>
                <div class="table-lab-info">{{ pi.school }}, {{ pi.department }}</div>
                {% if pi.get('h_index') %}
                  <div class="table-lab-info" style="margin-top: 0.25rem; font-size: 0.85rem; color: var(--text-muted);">
                    H-index: <strong style="color: var(--accent);">{{ pi.h_index }}</strong>
                  </div>
                {% endif %}
                <div class="table-lab-info" style="margin-top: 0.25rem; font-size: 0.85rem; color: var(--text-dim);">{{ pi.get('specific_location', pi.location) }}</div>
                {% if pi.id in saved_pi_ids %}
                  <span class="saved-badge" style="margin-top: 0.5rem; display: inline-block; font-size: 0.75rem;">✓ Saved</span>
                {% endif %}
              </td>
              <td>
                <div class="table-lab-name" style="font-size: 0.9rem;">{{ pi.title }}</div>
                {% if pi.website %}
                  <a href="{{ pi.website }}" target="_blank" class="table-link" style="font-size: 0.85rem;">View Website</a>
                {% else %}
                  <span style="font-size: 0.85rem; color: var(--text-dim);">No website</span>
                {% endif %}
              </td>
              <td>
                <a href="mailto:{{ pi.email }}" class="table-email">{{ pi.email }}</a>
              </td>
              <td style="text-align: center;">
                <div class="score-circle table-fit-score" data-score="{{ pi.match_score }}" style="width: 70px; height: 70px; margin: 0 auto; position: relative; cursor: pointer;" 
                     onclick="toggleFitExplanation('fit-{{ pi.id }}')">
                  <span class="score-number">{{ pi.match_score }}</span>
                  <span class="score-label">Match</span>
                </div>
                {% if pi.match_reason %}
                  <button class="fit-explanation-btn" onclick="toggleFitExplanation('fit-{{ pi.id }}')">
                    Why this match?
                  </button>
                  <div id="fit-{{ pi.id }}" class="fit-explanation-popup" style="display: none;">
                    <div class="fit-explanation-content">
                      <button class="close-fit-explanation" onclick="toggleFitExplanation('fit-{{ pi.id }}')">×</button>
                      <h4>Match Explanation</h4>
                      <p>{{ pi.match_reason }}</p>
                    </div>
                  </div>
                {% endif %}
              </td>
              <td>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  {% if pi.id in saved_pi_ids %}
                    <span class="saved-indicator" style="font-size: 0.85rem; text-align: center;">Already saved</span>
                    <a href="{{ url_for('draft_email', pi_id=pi.id) }}" class="btn-primary" style="padding: 0.5rem; font-size: 0.85rem; text-align: center;">Draft Email</a>
                  {% else %}
                    <form method="post" action="{{ url_for('save_pi', pi_id=pi.id) }}" style="display: inline;">
                      <button type="submit" class="btn-primary" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">Save PI</button>
                    </form>
                    <a href="{{ url_for('draft_email', pi_id=pi.id) }}" class="btn-secondary" style="padding: 0.5rem; font-size: 0.85rem; text-align: center;">Draft Email</a>
                  {% endif %}
                </div>
              </td>
            </tr>
            <!-- Match reason row -->
            {% if pi.match_reason %}
              <tr class="match-reason-row" style="background: var(--bg-elevated);">
                <td colspan="6" style="padding: 1rem; border-top: none; padding-top: 0;">
                  <div class="match-reason" style="margin: 0;">
                    <strong>Why this match:</strong> {{ pi.match_reason }}
                  </div>
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="no-results">
      <p>No matches found. Try uploading or updating your resume.</p>
      <a href="{{ url_for('resume_upload') }}" class="btn-primary">Upload Resume</a>
    </div>
  {% endif %}
{% endblock %}

